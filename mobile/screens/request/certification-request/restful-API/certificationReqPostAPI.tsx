import { api } from "@/api/api";


// Function to get a valid resident profile ID (from caller)
const getValidResidentProfileId = async (userId?: string) => {
    if (!userId) {
        throw new Error("Error: No user ID provided");
    }
    return userId;
};

// Test function to check server connectivity
export const testServerConnection = async () => {
    try {
        // Test certificate endpoint directly (skip root URL test)
        const certResponse = await api.get('clerk/certificate/');
        
        // Test business permit endpoint
        const permitResponse = await api.get('clerk/business-permit/');
        
        return true;
    } catch (err: any) {
        return false;
    }
};

export const addCertificationRequest = async (requestInfo: Record<string, any>, staffId?: string, userId?: string) => {
    try {

        // Personal Certification (ClerkCertificate model)
        if (requestInfo.cert_type === 'personal') {
            // cr_id will be auto-generated by backend in format CR001-25
            
            // Get a valid resident profile ID
            const residentProfileId = await getValidResidentProfileId(userId);
            
            const payload = {
                // cr_id will be auto-generated by backend
                cr_req_request_date: new Date().toISOString().split('T')[0], 
                cr_req_transac_id: 'None', 
                cr_req_purpose: requestInfo.cert_category, 
                cr_req_status: 'Pending',
                cr_req_payment_status: 'Unpaid',
                pr_id: requestInfo.pr_id, 
                rp_id: residentProfileId, 
                serial_no: requestInfo.serialNo || null,
                requester: requestInfo.requester || 'Mobile User'
            };

            const res = await api.post('clerk/certificate/', payload);
            return res.data;
        }
        // Permit Certification (BusinessPermitRequest model)
        else if (requestInfo.cert_type === 'permit') {
            // bpr_id will be auto-generated by backend in format BR001-25
            
            const payload: any = {
                req_request_date: new Date().toISOString().split('T')[0], // Current date
                req_status: 'Pending',
                req_payment_status: 'Unpaid',
                req_amount: requestInfo.req_amount || 0,
                rp_id: await getValidResidentProfileId(userId),
                ags_id: requestInfo.ags_id || null, 
                pr_id: requestInfo.pr_id || null, 
                bus_permit_name: requestInfo.business_name || '', 
                bus_permit_address: requestInfo.business_address || '', 
                bus_clearance_gross_sales: requestInfo.bus_clearance_gross_sales ?? null,
                permit_image: requestInfo.permit_image || null,
                assessment_image: requestInfo.assessment_image || null
            };

            payload.bus_id = requestInfo.business_id || null;

            const res = await api.post('clerk/business-clearance/', payload);
            return res.data;
        } else {
            throw new Error('Invalid certification type');
        }

    } catch (err: any) {
        throw err;
    }
};

export const addBusinessClearance = async (requestInfo: Record<string, any>, staffId?: string, userId?: string) => {
    try {
        const payload: any = {
            // bpr_id will be auto-generated by backend in format BR001-25
            req_request_date: new Date().toISOString().split('T')[0], // Current date
            req_status: 'Pending',
            req_payment_status: 'Unpaid',
            req_amount: requestInfo.req_amount || 0, // Required amount field
            rp_id: await getValidResidentProfileId(userId),
            ags_id: requestInfo.ags_id || null, // Annual gross sales ID (optional)
            pr_id: requestInfo.pr_id || null, // Purpose and rate ID (optional)
            bus_permit_name: requestInfo.business_name || '', // Business name field
            bus_permit_address: requestInfo.business_address || '', // Business address field
            // Image fields for business_permit_file table (handled by backend)
            previous_permit_image: requestInfo.previous_permit_image || null,
            assessment_image: requestInfo.assessment_image || null
        };

        // Always include bus_id - use null if no business exists
        payload.bus_id = requestInfo.business_id || null;

        const res = await api.post('clerk/business-clearance/', payload);
        return res.data;

    } catch (err: any) {
        throw err;
    }
};


export const formatImageForUpload = (imageUri: string, fileName: string) => {
    return {
        name: fileName,
        type: 'image/jpeg', 
        path: imageUri,
        uri: imageUri
    };
};